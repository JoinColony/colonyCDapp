FROM colony-cdapp-dev-env/base:latest

ENV BLOCK_INGESTOR_HASH=9e0f81dce8178704fa689bedde2aa43ce82d9ecf

# Declare volumes to set up metadata
VOLUME [ "/colonyCDapp/amplify/mock-data" ]

# Add dependencies from the host
# Note: these are listed individually so that if they change, they won't affect
# the build of the other images
ADD docker/files/block-ingestor/run.sh.base /colonyCDappBackend/run.sh

WORKDIR /colonyCDappBackend

#
# Block Ingestor
#

# # Clone block ingestor repo
# RUN git clone https://github.com/JoinColony/block-ingestor.git --depth 1
# WORKDIR /colonyCDappBackend/block-ingestor

# RUN echo $BLOCK_INGESTOR_HASH
# # Fetch the correct network repo commit/branch/tag
# RUN git fetch origin $BLOCK_INGESTOR_HASH --depth 1
# RUN git checkout $BLOCK_INGESTOR_HASH

# TEMP: Checkout extension porting branch
RUN git clone https://github.com/JoinColony/block-ingestor.git
WORKDIR /colonyCDappBackend/block-ingestor
RUN git fetch origin port/extensions
RUN git checkout port/extensions

# Add env file here (as opposed to at the start of the script), since we
# need to add it after the repo has been cloned, otherwise cloning will fail
ADD docker/files/block-ingestor/env.base /colonyCDappBackend/block-ingestor/.env

# Install block ingestor dependencies
RUN npm install

# Compile JS files
RUN npm run build

WORKDIR /colonyCDappBackend

# Open up ports to the docker image
# Block Ingestor Stats
EXPOSE 10001

# Make the run script executable
RUN chmod +x ./run.sh

# Battlecruiser Operational!
CMD [ "./run.sh" ]
