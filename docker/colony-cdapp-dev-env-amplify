FROM colony-cdapp-dev-env/base:latest

# Declare volumes to set up metadata
VOLUME [ "/colonyCDapp/amplify/backend", "/colonyCDapp/amplify/mock-data", "/colonyCDapp/src/graphql" ]

WORKDIR /colonyCDapp

# Add dependencies from the host
ADD package.json /colonyCDapp/package.colonyCDapp.json
ADD amplify /colonyCDapp/amplify
ADD .graphqlconfig.yml /colonyCDapp/.graphqlconfig.yml

# Note: these are listed individually so that if they change, they won't affect
# the build of the other images
ADD docker/files/amplify/run.sh.base /colonyCDappBackend/run.sh
ADD docker/files/amplify/local-env-info.json.base /colonyCDapp/amplify/.config/local-env-info.json
ADD docker/files/amplify/local-aws-info.json.base /colonyCDapp/amplify/.config/local-aws-info.json
ADD docker/files/amplify/aws-exports.js.base /colonyCDapp/src/aws-exports.js
# This still needs to be saved as a "template" since it will only be moved to it's final location at runtime
ADD docker/files/amplify/amplify-meta.json.base /colonyCDappBackend/scripts/amplify-meta.json.base
ADD docker/files/amplify/config.base /root/.aws/config
ADD docker/files/amplify/credentials.base /root/.aws/credentials

#
# Amplify
#

# Generate the local "light" version of package json
# It gets the amplify version from the CDapp's package.json file
RUN AMPLIFY_VERSION=$(jq '.dependencies."@aws-amplify/cli"' package.colonyCDapp.json) && echo "{\"scripts\":{\"amplify\":\"amplify\"},\"dependencies\":{\"@aws-amplify/cli\": $AMPLIFY_VERSION}}" > package.json

# Install amplify as a dependency
RUN npm install

# Actually download the amplify tarball (don't ask me, it's how it works)
RUN npm run amplify

# Make the run script executable
RUN chmod +x /colonyCDappBackend/run.sh

# Battlecruiser Operational!
CMD [ "/colonyCDappBackend/run.sh" ]
